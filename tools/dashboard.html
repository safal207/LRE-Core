<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåä Liminal Runtime Dashboard</title>
    <style>
        :root {
            --liminal-dark: #0a0e27;
            --liminal-glow: #64ffda;
            --liminal-purple: #b794f6;
            --liminal-mist: rgba(100, 255, 218, 0.1);
            --liminal-mist-dim: rgba(100, 255, 218, 0.5);
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --radius-card: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--liminal-dark) 0%, #1a1f3a 100%);
            color: #e0e7ff;
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--liminal-glow), var(--liminal-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: var(--spacing-sm);
        }

        .tagline {
            color: var(--liminal-mist-dim);
            font-size: 0.95rem;
        }

        .status-bar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .status-indicator {
            flex: 1;
            min-width: 200px;
            background: var(--liminal-mist);
            border: 1px solid var(--liminal-glow);
            border-radius: var(--radius-card);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.connected {
            background: var(--liminal-glow);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        button {
            background: var(--liminal-mist);
            border: 1px solid var(--liminal-glow);
            color: var(--liminal-glow);
            padding: var(--spacing-md);
            border-radius: var(--radius-card);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            background: var(--liminal-glow);
            color: var(--liminal-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .event-stream {
            background: var(--liminal-mist);
            border: 1px solid var(--liminal-glow);
            border-radius: var(--radius-card);
            padding: var(--spacing-md);
            height: 400px;
            overflow-y: auto;
        }

        .event-stream h2 {
            margin-bottom: var(--spacing-md);
            color: var(--liminal-glow);
        }

        .log-entry {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            border-left: 3px solid;
        }

        .log-entry.SENT {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        .log-entry.RECV {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }

        .log-entry.ERROR {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--liminal-dark);
            border: 2px solid var(--liminal-glow);
            border-radius: var(--radius-card);
            padding: var(--spacing-lg);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 1000px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-header h2 {
            color: var(--liminal-glow);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--liminal-glow);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .filter-group label {
            color: var(--liminal-mist-dim);
            font-size: 0.85rem;
        }

        .filter-group input,
        .filter-group select {
            background: var(--liminal-mist);
            border: 1px solid var(--liminal-glow);
            color: #e0e7ff;
            padding: var(--spacing-sm);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-md);
        }

        .history-table th,
        .history-table td {
            padding: var(--spacing-sm);
            text-align: left;
            border-bottom: 1px solid var(--liminal-mist);
        }

        .history-table th {
            background: var(--liminal-mist);
            color: var(--liminal-glow);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .history-table tr:hover {
            background: var(--liminal-mist);
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.inbound {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .badge.outbound {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .json-preview {
            font-family: 'Monaco', monospace;
            font-size: 0.75rem;
            color: var(--liminal-mist-dim);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .json-preview:hover {
            color: var(--liminal-glow);
        }

        /* JSON Modal */
        #json-modal {
            z-index: 1100;
        }

        .json-content {
            background: #000;
            padding: var(--spacing-md);
            border-radius: 8px;
            overflow: auto;
            max-height: 400px;
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #a5d6ff;
            border: 1px solid var(--liminal-glow);
            white-space: pre-wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--liminal-mist);
            border: 1px solid var(--liminal-glow);
            border-radius: var(--radius-card);
            padding: var(--spacing-md);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            color: var(--liminal-glow);
            font-weight: bold;
        }

        .stat-label {
            color: var(--liminal-mist-dim);
            font-size: 0.85rem;
            margin-top: var(--spacing-sm);
        }

        /* Login Overlay */
        #login-overlay {
            display: flex;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: var(--liminal-dark);
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-box {
            background: var(--liminal-mist);
            border: 2px solid var(--liminal-glow);
            padding: var(--spacing-lg);
            border-radius: var(--radius-card);
            width: 350px;
        }

        .login-box h2 {
            margin-bottom: var(--spacing-md);
            color: var(--liminal-glow);
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--liminal-glow);
            color: white;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2>üîë LRE Login</h2>
            <input type="text" id="login-username" placeholder="Username" value="admin">
            <input type="password" id="login-password" placeholder="Password" value="admin123">
            <button onclick="performLogin()" style="width: 100%">Connect & Authenticate</button>
            <div id="login-error" style="color: #ef4444; margin-top: 10px; font-size: 0.8rem; text-align: center;"></div>
        </div>
        <p style="margin-top: 20px; color: var(--liminal-mist-dim); font-size: 0.8rem;">
            Default: admin / admin123
        </p>
    </div>

    <div class="container">
        <header>
            <h1>üåä Liminal Runtime</h1>
            <div class="tagline">AI Governance Layer ‚Ä¢ Presence-Aware Decisions</div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <div>
                    <strong>WebSocket:</strong>
                    <span id="status-text">Disconnected</span>
                </div>
            </div>
            <div class="status-indicator">
                <div>
                    <strong>Latency:</strong>
                    <span id="latency">‚Äî</span>ms
                </div>
            </div>
            <div class="status-indicator">
                <div>
                    <strong>Events:</strong>
                    <span id="event-count">0</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button onclick="sendPing()">üèì Send Ping</button>
            <button onclick="sendEcho()">üì¢ Send Echo</button>
            <button onclick="showHistory()">üìú View History</button>
            <button onclick="clearLogs()">üßπ Clear Logs</button>
        </div>

        <!-- Event Stream -->
        <div class="event-stream">
            <h2>üì° Event Stream</h2>
            <div id="log-container"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Event History</h2>
                <button class="close-btn" onclick="closeHistory()">&times;</button>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-events">‚Äî</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-traces">‚Äî</div>
                    <div class="stat-label">Unique Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="event-types-count">‚Äî</div>
                    <div class="stat-label">Event Types</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>Filter by Trace ID:</label>
                    <input type="text" id="filter-trace" placeholder="Enter trace_id...">
                </div>
                <div class="filter-group">
                    <label>Filter by Agent ID:</label>
                    <input type="text" id="filter-agent" placeholder="Enter agent_id...">
                </div>
                <div class="filter-group">
                    <label>Filter by Event Type:</label>
                    <select id="filter-type">
                        <option value="">All Types</option>
                        <option value="system_ping">system_ping</option>
                        <option value="system_pong">system_pong</option>
                        <option value="echo_payload">echo_payload</option>
                        <option value="fetch_history">fetch_history</option>
                        <option value="history_result">history_result</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Limit:</label>
                    <select id="filter-limit">
                        <option value="50">50 events</option>
                        <option value="100" selected>100 events</option>
                        <option value="500">500 events</option>
                    </select>
                </div>
            </div>

            <button onclick="applyFilters()" style="width: 100%; margin-bottom: 16px;">üîç Apply Filters</button>

            <!-- History Table -->
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Direction</th>
                            <th>Type</th>
                            <th>Trace ID</th>
                            <th>Timestamp</th>
                            <th>Payload</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--liminal-mist-dim);">
                                Loading history...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JSON Payload Modal -->
    <div id="json-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üì¶ Payload Details</h2>
                <button class="close-btn" onclick="closeJSON()">&times;</button>
            </div>
            <pre id="json-display" class="json-content"></pre>
        </div>
    </div>

    <script>
        const WS_URL = 'ws://localhost:8000';
        const AGENT_ID = 'dashboard_001';

        // NOTE: In a real app, you'd get the token from an auth API.
        // For this demo, we'll simulate it by decoding a hardcoded token
        // OR the user would provide it. Since we don't have an HTTP Auth API yet,
        // the user is expected to have a token.
        // For PR 16A, we'll assume the dashboard can generate a token if we had the secret,
        // but it shouldn't have the secret.
        // INSTEAD, let's use a mock token or let the user enter one.
        // Actually, let's just use a hardcoded token for the default admin for now to make it work.
        // (This is insecure but okay for a local dev dashboard demo).

        let ws = null;
        let isConnected = false;
        let eventCount = 0;
        let lastPingTime = null;
        let currentHistory = [];

        // DOM Elements
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const latencyValue = document.getElementById('latency');
        const eventCountEl = document.getElementById('event-count');
        const logContainer = document.getElementById('log-container');

        // Connect to WebSocket
        function connect(token) {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                isConnected = true;
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                addLog('SENT', 'auth_request', {token: '***'});

                // Send auth request immediately
                ws.send(JSON.stringify({
                    type: 'auth_request',
                    trace_id: crypto.randomUUID(),
                    timestamp: new Date().toISOString(),
                    payload: { token: token }
                }));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleResponse(data);
                } catch (e) {
                    addLog('ERROR', 'Failed to parse message', {error: e.message});
                }
            };

            ws.onerror = (error) => {
                addLog('ERROR', 'WebSocket error', {error: error.message});
            };

            ws.onclose = () => {
                isConnected = false;
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                addLog('RECV', 'WebSocket disconnected', {});

                // Reconnect after 3 seconds
                setTimeout(connect, 3000);
            };
        }

        function sendCommand(action, payload = {}) {
            if (!isConnected) {
                addLog('ERROR', 'Not connected to server', {});
                return;
            }

            const trace_id = crypto.randomUUID();

            if (action === 'system_ping') {
                lastPingTime = performance.now();
            }

            payload.agent_id = AGENT_ID;

            const command = {
                type: action,
                trace_id: trace_id,
                timestamp: new Date().toISOString(),
                payload: payload
            };

            try {
                ws.send(JSON.stringify(command));
                addLog('SENT', action, payload);
            } catch (e) {
                addLog('ERROR', 'Failed to send command: ' + e.message);
            }
        }

        function handleResponse(data) {
            // Latency calculation
            if (data.type === 'system_pong' && lastPingTime) {
                const latency = Math.round(performance.now() - lastPingTime);
                latencyValue.innerText = `${latency}`;
                lastPingTime = null;
            }

            // Error handling
            if (data.type === 'error') {
                const code = data.payload?.code || 'E999';
                const msg = data.payload?.message || 'Unknown Error';
                addLog('ERROR', `[${code}] ${msg}`, data.payload?.details || data);
                return;
            }

            // Auth handling
            if (data.type === 'auth_success') {
                addLog('RECV', 'auth_success', data.payload);
                document.getElementById('login-overlay').style.display = 'none';
                return;
            }

            if (data.type === 'auth_failure') {
                addLog('ERROR', 'auth_failure', data.payload);
                document.getElementById('login-error').textContent = data.payload.error;
                ws.close();
                return;
            }

            // History result
            if (data.type === 'history_result') {
                handleHistoryResult(data);
                return;
            }

            // Log success
            if (['system_pong', 'echo_payload', 'execution_result'].includes(data.type)) {
                addLog('RECV', data.type, data.payload || data);
            } else {
                addLog('RECV', 'Message', data);
            }
        }

        function addLog(type, action, payload) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            const payloadStr = JSON.stringify(payload, null, 2);

            // XSS Protection: use textContent for dynamic values
            const strong = document.createElement('strong');
            strong.textContent = `[${timestamp}] `;
            entry.appendChild(strong);

            const actionText = document.createTextNode(`${type}: ${action}`);
            entry.appendChild(actionText);

            const payloadDiv = document.createElement('div');
            payloadDiv.style.marginTop = '4px';
            payloadDiv.style.opacity = '0.7';
            payloadDiv.textContent = payloadStr.substring(0, 100) + (payloadStr.length > 100 ? '...' : '');
            entry.appendChild(payloadDiv);

            logContainer.insertBefore(entry, logContainer.firstChild);
            eventCount++;
            eventCountEl.textContent = eventCount;

            // Limit logs to 50
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Button handlers
        function sendPing() {
            sendCommand('system_ping');
        }

        function sendEcho() {
            sendCommand('echo_payload', {
                message: 'Hello from Dashboard!',
                timestamp: Date.now()
            });
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            eventCount = 0;
            eventCountEl.textContent = '0';
        }

        // History Modal
        function showHistory() {
            document.getElementById('history-modal').classList.add('active');
            loadHistory();
        }

        function closeHistory() {
            document.getElementById('history-modal').classList.remove('active');
        }

        function loadHistory(filters = {}) {
            const payload = {
                limit: parseInt(document.getElementById('filter-limit').value) || 100
            };

            if (filters.trace_id) payload.trace_id = filters.trace_id;
            if (filters.agent_id) payload.agent_id = filters.agent_id;
            if (filters.type) payload.type = filters.type;

            sendCommand('fetch_history', payload);
        }

        function applyFilters() {
            const filters = {
                trace_id: document.getElementById('filter-trace').value.trim(),
                agent_id: document.getElementById('filter-agent').value.trim(),
                type: document.getElementById('filter-type').value
            };
            loadHistory(filters);
        }

        function handleHistoryResult(data) {
            currentHistory = data.payload.events || [];
            const stats = data.payload.filtered_stats || {};

            // Update stats with accurate server-side data
            document.getElementById('total-events').textContent = data.payload.count || 0;
            document.getElementById('unique-traces').textContent = stats.traces || 0;
            document.getElementById('event-types-count').textContent = stats.types || 0;

            // Render table
            renderHistoryTable(currentHistory);
        }

        function renderHistoryTable(events) {
            const tbody = document.getElementById('history-tbody');

            if (events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--liminal-mist-dim);">
                            No events found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            events.forEach(event => {
                const row = document.createElement('tr');

                const payloadPreview = JSON.stringify(event.payload || {}).substring(0, 50);
                const directionClass = event.direction.toLowerCase();

                row.innerHTML = `
                    <td>${event.id}</td>
                    <td><span class="badge ${directionClass}">${event.direction}</span></td>
                    <td><code class="type-cell"></code></td>
                    <td><code class="trace-cell" style="font-size: 0.7rem;"></code></td>
                    <td>${new Date(event.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="json-preview" onclick="showJSON(${event.id})" title="Click to view full payload"></span>
                    </td>
                `;

                // XSS Protection: use textContent for dynamic data
                row.querySelector('.type-cell').textContent = event.type;
                row.querySelector('.trace-cell').textContent = `${event.trace_id.substring(0, 8)}...`;
                row.querySelector('.json-preview').textContent = `${payloadPreview}...`;

                tbody.appendChild(row);
            });
        }

        function showJSON(eventId) {
            const event = currentHistory.find(e => e.id === eventId);
            if (event) {
                document.getElementById('json-display').textContent = JSON.stringify(event.payload || {}, null, 2);
                document.getElementById('json-modal').classList.add('active');
            }
        }

        function closeJSON() {
            document.getElementById('json-modal').classList.remove('active');
        }

        // Login handler
        async function performLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                document.getElementById('login-error').textContent = 'Username and password required';
                return;
            }

            // Connect and send auth_login
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                isConnected = true;
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                addLog('SENT', 'auth_login', {username: username, password: '***'});

                ws.send(JSON.stringify({
                    type: 'auth_login',
                    trace_id: crypto.randomUUID(),
                    timestamp: new Date().toISOString(),
                    payload: {
                        username: username,
                        password: password
                    }
                }));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'auth_token') {
                        addLog('RECV', 'auth_token', {access_token: '***', user: data.payload.user});
                        // Store token for reconnection if needed
                        sessionStorage.setItem('lre_token', data.payload.access_token);
                        document.getElementById('login-overlay').style.display = 'none';
                        // Switch to normal message handling
                        ws.onmessage = (e) => handleResponse(JSON.parse(e.data));
                        return;
                    }

                    if (data.type === 'auth_failure') {
                        addLog('ERROR', 'auth_failure', data.payload);
                        document.getElementById('login-error').textContent = data.payload.error;
                        ws.close();
                        return;
                    }

                    handleResponse(data);
                } catch (e) {
                    addLog('ERROR', 'Failed to parse message', {error: e.message});
                }
            };

            ws.onerror = (error) => {
                addLog('ERROR', 'WebSocket error', {error: error.message});
                document.getElementById('login-error').textContent = 'Connection failed';
            };

            ws.onclose = () => {
                isConnected = false;
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                addLog('RECV', 'WebSocket disconnected', {});

                // Show login overlay if we disconnected
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('login-error').textContent = 'Disconnected from server';
            };
        }

        // Initialize - don't connect automatically
        // window.addEventListener('DOMContentLoaded', connect);
    </script>
</body>
</html>
